<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能條碼管理器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 JsBarcode 用於生成條碼 -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- 引入 qrcode-generator 用於生成 QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 簡單的切換動畫 */
        .view {
            transition: opacity 0.3s ease-in-out;
        }
        .hidden-view {
            display: none;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div class="container mx-auto max-w-3xl p-4 md:p-8">

        <!-- 顯示模式 -->
        <div id="display-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white">我的條碼</h1>
                <div class="flex space-x-2">
                    <button id="save-file-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800 transition-transform transform hover:scale-105">
                        儲存
                    </button>
                    <button id="load-file-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-yellow-300 dark:focus:ring-yellow-800 transition-transform transform hover:scale-105">
                        載入
                    </button>
                    <button id="edit-mode-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800 transition-transform transform hover:scale-105">
                        編輯
                    </button>
                </div>
            </div>
            
            <!-- 隱藏的檔案輸入元素 -->
            <input type="file" id="file-input" accept=".json" style="display: none;">
            
            <!-- 載入狀態訊息 -->
            <div id="loading-message" class="hidden bg-blue-100 dark:bg-blue-900 border border-blue-400 dark:border-blue-600 text-blue-700 dark:text-blue-300 px-4 py-3 rounded mb-4">
                正在載入資料...
            </div>
            
            <!-- 錯誤訊息 -->
            <div id="error-message" class="hidden bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 px-4 py-3 rounded mb-4">
                <span id="error-text"></span>
            </div>
            
            <!-- 成功訊息 -->
            <div id="success-message" class="hidden bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-600 text-green-700 dark:text-green-300 px-4 py-3 rounded mb-4">
                <span id="success-text"></span>
            </div>
            <div id="barcode-list-display" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 條碼會顯示在這裡 -->
            </div>
             <div id="no-items-message-display" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
                <p class="text-lg">目前沒有任何條碼。</p>
                <p>請進入編輯模式新增一個！</p>
            </div>
        </div>

        <!-- 編輯模式 -->
        <div id="edit-view" class="view hidden-view">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white">編輯模式</h1>
                <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800 transition-transform transform hover:scale-105">
                    完成
                </button>
            </div>
            <div id="barcode-list-edit" class="space-y-6">
                <!-- 編輯表單會顯示在這裡 -->
            </div>
            <div id="no-items-message-edit" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
                <p class="text-lg">點擊下方按鈕新增第一個條碼！</p>
            </div>
            <div class="mt-8 text-center">
                <button id="add-new-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 transition-transform transform hover:scale-105">
                    ＋ 新增條碼
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const displayView = document.getElementById('display-view');
            const editView = document.getElementById('edit-view');
            const editModeBtn = document.getElementById('edit-mode-btn');
            const saveBtn = document.getElementById('save-btn');
            const addNewBtn = document.getElementById('add-new-btn');
            const barcodeListDisplay = document.getElementById('barcode-list-display');
            const barcodeListEdit = document.getElementById('barcode-list-edit');
            const noItemsMsgDisplay = document.getElementById('no-items-message-display');
            const noItemsMsgEdit = document.getElementById('no-items-message-edit');

            // 應用程式狀態
            let codes = [];

            // 預設載入 URL（可以修改為您想要的預設資料源）
            const DEFAULT_DATA_URL = 'default-barcode.json';

            // 從 localStorage 載入資料
            function loadFromStorage() {
                const storedCodes = localStorage.getItem('barcodeAppCodes');
                if (storedCodes) {
                    codes = JSON.parse(storedCodes);
                } else {
                    // 如果沒有儲存的資料，提供一些範例
                    codes = [
                        { id: Date.now(), name: '薯條1+1', type: 'CODE128', data: 'P0589' },
                        { id: Date.now() + 1, name: '自由配', type: 'CODE128', data: 'P0517' }
                    ];
                }
            }

            // 儲存資料到 localStorage
            function saveToStorage() {
                localStorage.setItem('barcodeAppCodes', JSON.stringify(codes));
            }

            // 顯示訊息函式
            function showMessage(type, text, duration = 3000) {
                const messageElement = document.getElementById(`${type}-message`);
                const textElement = document.getElementById(`${type}-text`);
                
                if (textElement) {
                    textElement.textContent = text;
                }
                
                messageElement.classList.remove('hidden');
                
                setTimeout(() => {
                    messageElement.classList.add('hidden');
                }, duration);
            }

            // 儲存資料到檔案
            function saveToFile() {
                try {
                    const dataStr = JSON.stringify(codes, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `barcode-data-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showMessage('success', '檔案已成功儲存！');
                } catch (error) {
                    showMessage('error', '儲存檔案時發生錯誤：' + error.message);
                }
            }

            // 從檔案載入資料
            function loadFromFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                resolve(data);
                            } else {
                                reject(new Error('檔案格式不正確：應為條碼陣列'));
                            }
                        } catch (error) {
                            reject(new Error('檔案格式不正確：' + error.message));
                        }
                    };
                    reader.onerror = function() {
                        reject(new Error('檔案讀取失敗'));
                    };
                    reader.readAsText(file);
                });
            }

            // 從 URL 載入資料
            async function loadFromURL(url) {
                try {
                    showMessage('loading', '正在從 URL 載入資料...');
                    document.getElementById('loading-message').classList.remove('hidden');
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (!Array.isArray(data)) {
                        throw new Error('URL 回傳的資料格式不正確：應為條碼陣列');
                    }
                    
                    codes = data;
                    saveToStorage();
                    renderDisplayView();
                    
                    document.getElementById('loading-message').classList.add('hidden');
                    showMessage('success', `成功從 URL 載入 ${codes.length} 個條碼！`);
                    
                } catch (error) {
                    document.getElementById('loading-message').classList.add('hidden');
                    showMessage('error', '從 URL 載入失敗：' + error.message);
                }
            }

            // 檢查 URL 參數並載入
            function checkURLParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const loadUrl = urlParams.get('url');
                
                if (loadUrl) {
                    // 從 URL 參數指定的位置載入
                    loadFromURL(decodeURIComponent(loadUrl));
                } else {
                    // 嘗試從預設 URL 載入（靜默失敗）
                    loadFromDefaultURL();
                }
            }

            // 從預設 URL 載入資料（靜默失敗）
            async function loadFromDefaultURL() {
                try {
                    const response = await fetch(DEFAULT_DATA_URL);
                    if (response.ok) {
                        const data = await response.json();
                        if (Array.isArray(data) && data.length > 0) {
                            // 只有在本地沒有資料時才使用預設資料
                            const storedCodes = localStorage.getItem('barcodeAppCodes');
                            if (!storedCodes) {
                                codes = data;
                                saveToStorage();
                                renderDisplayView();
                                showMessage('success', `已載入預設資料：${codes.length} 個條碼`);
                            }
                        }
                    }
                } catch (error) {
                    // 靜默失敗，使用本地範例資料
                    console.log('無法載入預設資料，使用本地範例資料');
                }
            }

            // --- 渲染函式 ---

            // 渲染顯示模式
            function renderDisplayView() {
                barcodeListDisplay.innerHTML = '';
                if (codes.length === 0) {
                    noItemsMsgDisplay.classList.remove('hidden');
                } else {
                    noItemsMsgDisplay.classList.add('hidden');
                    codes.forEach(code => {
                        const card = document.createElement('div');
                        card.className = 'bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md flex flex-col items-center';
                        
                        const codeId = `display-${code.type}-${code.id}`;
                        let codeElement = '';
                        if (code.type === 'qrcode') {
                            codeElement = `<div id="${codeId}" class="w-full max-w-[200px] h-auto"></div>`;
                        } else {
                            codeElement = `<svg id="${codeId}" class="w-full"></svg>`;
                        }

                        card.innerHTML = `
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">${code.name || '未命名'}</h3>
                            <div class="bg-white p-4 rounded-lg w-full flex justify-center">${codeElement}</div>
                        `;
                        barcodeListDisplay.appendChild(card);
                        
                        // 延遲一點時間來生成圖碼，確保 DOM 已渲染
                        setTimeout(() => generateSingleCode(code.type, code.data, `#${codeId}`), 50);
                    });
                }
            }

            // 渲染編輯模式
            function renderEditView() {
                barcodeListEdit.innerHTML = '';
                 if (codes.length === 0) {
                    noItemsMsgEdit.classList.remove('hidden');
                } else {
                    noItemsMsgEdit.classList.add('hidden');
                    codes.forEach(code => {
                        const formCard = document.createElement('div');
                        formCard.className = 'bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md space-y-4';
                        formCard.dataset.id = code.id;

                        formCard.innerHTML = `
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-white">編輯項目</h3>
                                <button class="delete-btn text-red-500 hover:text-red-700 font-semibold" data-id="${code.id}">刪除</button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">名稱</label>
                                <input type="text" value="${code.name}" data-field="name" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">類型</label>
                                <select data-field="type" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500">
                                    <option value="qrcode" ${code.type === 'qrcode' ? 'selected' : ''}>QR Code</option>
                                    <option value="CODE128" ${code.type === 'CODE128' ? 'selected' : ''}>CODE128</option>
                                    <option value="EAN13" ${code.type === 'EAN13' ? 'selected' : ''}>EAN-13</option>
                                    <option value="UPC" ${code.type === 'UPC' ? 'selected' : ''}>UPC</option>
                                    <option value="CODE39" ${code.type === 'CODE39' ? 'selected' : ''}>CODE39</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">內容</label>
                                <input type="text" value="${code.data}" data-field="data" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500">
                            </div>
                        `;
                        barcodeListEdit.appendChild(formCard);
                    });
                }
            }

            // 生成單一圖碼的輔助函式
            function generateSingleCode(type, data, selector) {
                try {
                    if (type === 'qrcode') {
                        const container = document.querySelector(selector);
                        if (!container) return;
                        container.innerHTML = ''; // 清空
                        const qr = qrcode(0, 'M');
                        qr.addData(data);
                        qr.make();
                        container.innerHTML = qr.createImgTag(5, 4);
                        container.firstChild.style.width = "100%";
                        container.firstChild.style.height = "auto";
                    } else {
                        JsBarcode(selector, data, {
                            format: type,
                            lineColor: document.body.classList.contains('dark') ? "#FFF" : "#000",
                            width: 2,
                            height: 80,
                            displayValue: true,
                            fontOptions: "bold",
                            font: "Inter",
                            background: "transparent",
                            fontColor: document.body.classList.contains('dark') ? "#FFF" : "#000",
                        });
                    }
                } catch (e) {
                    const element = document.querySelector(selector);
                    if (element) {
                        if (element.tagName === 'DIV') {
                             element.innerHTML = `<p class="text-red-500 text-xs text-center">生成失敗</p>`;
                        } else {
                            // For SVG, we can't easily put text, so we clear it.
                            element.innerHTML = '';
                        }
                    }
                    console.error("生成失敗:", e);
                }
            }
            
            // --- 事件處理 ---

            // 切換到編輯模式
            editModeBtn.addEventListener('click', () => {
                renderEditView();
                displayView.classList.add('hidden-view');
                editView.classList.remove('hidden-view');
            });

            // 儲存並切換回顯示模式
            saveBtn.addEventListener('click', () => {
                // FIX: Selector was too broad and selected delete buttons as well.
                // This now specifically selects the DIV containers for each card.
                const editCards = barcodeListEdit.querySelectorAll('div[data-id]');
                const newCodes = [];
                editCards.forEach(card => {
                    const id = Number(card.dataset.id);
                    const name = card.querySelector('[data-field="name"]').value;
                    const type = card.querySelector('[data-field="type"]').value;
                    const data = card.querySelector('[data-field="data"]').value;
                    newCodes.push({ id, name, type, data });
                });
                codes = newCodes;
                saveToStorage();
                renderDisplayView();
                editView.classList.add('hidden-view');
                displayView.classList.remove('hidden-view');
            });

            // 新增一個條碼項目
            addNewBtn.addEventListener('click', () => {
                const newCode = {
                    id: Date.now(),
                    name: '新項目',
                    type: 'qrcode',
                    data: '請編輯內容'
                };
                codes.push(newCode);
                renderEditView(); // 重新渲染編輯列表以包含新項目
            });

            // 刪除條碼項目 (使用事件委派)
            barcodeListEdit.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const idToDelete = Number(e.target.dataset.id);
                    codes = codes.filter(code => code.id !== idToDelete);
                    renderEditView(); // 重新渲染編輯列表
                }
            });

            // 儲存檔案按鈕
            document.getElementById('save-file-btn').addEventListener('click', saveToFile);

            // 載入檔案按鈕
            document.getElementById('load-file-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            // 檔案輸入變更事件
            document.getElementById('file-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const loadedCodes = await loadFromFile(file);
                    codes = loadedCodes;
                    saveToStorage();
                    renderDisplayView();
                    showMessage('success', `成功載入 ${codes.length} 個條碼！`);
                } catch (error) {
                    showMessage('error', '載入檔案失敗：' + error.message);
                }

                // 清空文件輸入，允許重複載入同一個檔案
                e.target.value = '';
            });

            // --- 初始化 ---
            function init() {
                loadFromStorage();
                renderDisplayView();
                // 檢查 URL 參數並載入遠端資料
                checkURLParams();
            }

            init();
        });
    </script>
</body>
</html>
